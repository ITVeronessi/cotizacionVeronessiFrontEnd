<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Seleccionar Cirugía, Anestesia y Medicamentos</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>

    <script>
        let anestesiasGlobal = [];
        let medicamentosGlobal = [];
        console.log(medicamentosGlobal);
        let insumosGlobal = [];
        console.log(insumosGlobal);
        let equiposGlobal = [];

        // ------------------- CARGAR DATOS -------------------
        async function cargarTiposAnestesia() {
            const select = document.getElementById('tipo-anestesia');
            try {
                const response = await fetch('https://cotizacionveronessi.onrender.com/tipo-anestesia/');
                if (!response.ok) throw new Error('Error al cargar tipos de anestesia');
                const tipos = await response.json();

                select.innerHTML = '<option value="">-- Seleccione Tipo de Anestesia --</option>';
                tipos.forEach(tipo => {
                    const option = document.createElement('option');
                    option.value = tipo.idtipoanestecia;
                    option.textContent = tipo.nombre;
                    select.appendChild(option);
                });
            } catch (error) {
                console.error('Error cargarTiposAnestesia:', error);
            }
        }

        async function cargarAnestesias() {
            const tipoId = document.getElementById('tipo-anestesia').value;
            const select = document.getElementById('anestesia');
            if (!tipoId) {
                select.innerHTML = '<option value="">-- Seleccione Anestesia --</option>';
                return;
            }

            try {
                const response = await fetch('https://cotizacionveronessi.onrender.com/anestesia/');
                if (!response.ok) throw new Error('Error al cargar anestesias');
                const anestesias = await response.json();
                anestesiasGlobal = anestesias;

                const filtradas = anestesias.filter(a => a.tipo_anestesia === parseInt(tipoId));
                select.innerHTML = '<option value="">-- Seleccione Anestesia --</option>';
                filtradas.forEach(a => {
                    const option = document.createElement('option');
                    option.value = a.idanestecia;
                    option.textContent = `${a.nombre} - $${a.precio}`;
                    select.appendChild(option);
                });
            } catch (error) {
                console.error('Error cargarAnestesias:', error);
            }
        }

        async function cargarMedicamentos() {
            const select = document.getElementById('medicamento');
            try {
                const response = await fetch('https://cotizacionveronessi.onrender.com/medicamentos/');
                if (!response.ok) throw new Error('Error al cargar medicamentos');
                const medicamentos = await response.json();
                medicamentosGlobal = medicamentos;

                select.innerHTML = '<option value="">-- Seleccione Medicamento --</option>';
                medicamentos.forEach(med => {
                    const option = document.createElement('option');
                    option.value = med.idmedicamentos;
                    option.textContent = `${med.nombremedicamento} - $${med.precio}`;
                    select.appendChild(option);
                });
            } catch (error) {
                console.error('Error cargarMedicamentos:', error);
            }
        }

        async function cargarInsumos() {
            const select = document.getElementById('insumo');
            try {
                const response = await fetch('https://cotizacionveronessi.onrender.com/insumos/');
                if (!response.ok) throw new Error('Error al cargar insumos');
                const insumos = await response.json();
                insumosGlobal = insumos;

                select.innerHTML = '<option value="">-- Seleccione Insumo --</option>';
                insumos.forEach(i => {
                    const option = document.createElement('option');
                    option.value = i.idinsumos; // Ajustar según API
                    option.textContent = `${i.nombreinsumo} - $${i.precio}`; // Ajustar según API
                    select.appendChild(option);
                });
            } catch (error) {
                console.error('Error cargarInsumos:', error);
            }
        }

        async function cargarEquipos() {
            const select = document.getElementById('equipo');
            try {
                const response = await fetch('https://cotizacionveronessi.onrender.com/equipos/');
                if (!response.ok) throw new Error('Error al cargar equipos');
                const equipos = await response.json();
                equiposGlobal = equipos;

                select.innerHTML = '<option value="">-- Seleccione Equipo --</option>';
                equipos.forEach(e => {
                    const option = document.createElement('option');
                    option.value = e.idequipos; // Ajustar según API
                    option.textContent = `${e.nombreequipo} - $${e.precio}`; // Ajustar según API
                    select.appendChild(option);
                });
            } catch (error) {
                console.error('Error cargarEquipos:', error);
            }
        }

        // ------------------- TABLA -------------------
        function agregarATabla(tipo, nombre, precio) {
            const tbody = document.getElementById('tabla-items').querySelector('tbody');
            const fila = document.createElement('tr');
            fila.innerHTML = `
                <td class="border px-2 py-1">${tipo}</td>
                <td class="border px-2 py-1">${nombre}</td>
                <td class="border px-2 py-1">${precio.toFixed(2)}</td>
            `;
            tbody.appendChild(fila);
            actualizarTotal();
        }

        function actualizarTotal() {
            let total = 0;
            document.querySelectorAll('#tabla-items tbody tr').forEach(fila => total += parseFloat(fila.cells[2].textContent));
            document.getElementById('total').textContent = total.toFixed(2);
        }

        // ------------------- AGREGAR ITEMS -------------------
        function agregarAnestesia() {
            const select = document.getElementById('anestesia');
            const seleccionado = anestesiasGlobal.find(a => a.idanestecia === parseInt(select.value));
            if (seleccionado) agregarATabla('Anestesia', seleccionado.nombre, parseFloat(seleccionado.precio));
        }

        function agregarMedicamento() {
            const select = document.getElementById('medicamento');
            const seleccionado = medicamentosGlobal.find(m => m.idmedicamentos === parseInt(select.value));
            console.log(seleccionado);
            if (seleccionado) agregarATabla('Medicamento', seleccionado.nombremedicamento, parseFloat(seleccionado.precio));
        }
        //falta que funciome insumos
        function agregarInsumo() {
            const select = document.getElementById('insumo');
            const seleccionado = insumosGlobal.find(i => i.idinsumos === parseInt(select.value));
            console.log(seleccionado);
            if (seleccionado) agregarATabla('Insumo', seleccionado.nombreinsumo, parseFloat(seleccionado.precio));
        }

        function agregarEquipo() {
            const select = document.getElementById('equipo');
            const seleccionado = equiposGlobal.find(e => e.idequipos === parseInt(select.value));
            if (seleccionado) agregarATabla('Equipo', seleccionado.nombreequipo, parseFloat(seleccionado.precio));
        }

        function agregarDiasIngreso() {
            const dias = parseInt(document.getElementById('dias-ingreso').value);
            const valor = parseFloat(document.getElementById('valor-ingreso').value);
            if (!dias || !valor) return alert('Ingrese días y valor válidos');
            const totalDias = dias * valor; // multiplicamos por la cantidad de días
            agregarATabla('Días de Ingreso', `${dias} días`, totalDias);
            document.getElementById('dias-ingreso').value = '';
            document.getElementById('valor-ingreso').value = '';
        }


        // ------------------- INIT -------------------
        window.addEventListener('DOMContentLoaded', () => {
            cargarTiposAnestesia();
            cargarMedicamentos();
            cargarInsumos();
            cargarEquipos();
            document.getElementById('tipo-anestesia').addEventListener('change', cargarAnestesias);
            document.getElementById('btn-agregar-anestesia').addEventListener('click', agregarAnestesia);
            document.getElementById('btn-agregar-medicamento').addEventListener('click', agregarMedicamento);
            document.getElementById('btn-agregar-insumo').addEventListener('click', agregarInsumo);
            document.getElementById('btn-agregar-equipo').addEventListener('click', agregarEquipo);
            document.getElementById('agregar-dias').addEventListener('click', agregarDiasIngreso);
        });
    </script>
</head>

<body class="bg-gray-100 min-h-screen flex items-center justify-center p-6">
    <div class="bg-white rounded-xl shadow-lg p-6 sm:p-8 w-full max-w-lg mx-auto">
        <h1 class="text-2xl font-bold text-gray-800 mb-6 text-center">
            Seleccionar Cirugía, Anestesia y Medicamentos
        </h1>

        <!-- Tipo de Anestesia -->
        <div class="w-full max-w-xs sm:max-w-md mx-auto mb-4">
            <label for="tipo-anestesia" class="block text-gray-700 font-medium mb-2">Tipo de Anestesia:</label>
            <select id="tipo-anestesia" class="w-full border rounded p-2 text-sm sm:text-base">
                <option value="">Cargando tipo de anestesia...</option>
            </select>
        </div>

        <!-- Anestesia -->
        <div class="mb-4 flex flex-col sm:flex-row gap-2 sm:items-end">
            <div class="flex-1">
                <label for="anestesia" class="block text-gray-700 font-medium mb-2">Anestesia:</label>
                <select id="anestesia" class="w-full border rounded p-2 text-sm sm:text-base">
                    <option value="">-- Seleccione Anestesia --</option>
                </select>
            </div>
            <button type="button" id="btn-agregar-anestesia"
                class="bg-blue-500 text-white px-4 py-2 rounded w-full sm:w-auto">Agregar</button>
        </div>

        <!-- Medicamentos -->
        <div class="mb-4 flex flex-col sm:flex-row gap-2 sm:items-end">
            <div class="flex-1">
                <label for="medicamento" class="block text-gray-700 font-medium mb-2">Medicamento:</label>
                <select id="medicamento" class="w-full border rounded p-2 text-sm sm:text-base">
                    <option value="">-- Seleccione Medicamento --</option>
                </select>
            </div>
            <button type="button" id="btn-agregar-medicamento"
                class="bg-blue-500 text-white px-4 py-2 rounded w-full sm:w-auto">Agregar</button>
        </div>

        <!-- Insumos -->
        <div class="mb-4 flex flex-col sm:flex-row gap-2 sm:items-end">
            <div class="flex-1">
                <label for="insumo" class="block text-gray-700 font-medium mb-2">Insumo:</label>
                <select id="insumo" class="w-full border rounded p-2 text-sm sm:text-base">
                    <option value="">-- Seleccione Insumo --</option>
                </select>
            </div>
            <button type="button" id="btn-agregar-insumo"
                class="bg-blue-500 text-white px-4 py-2 rounded w-full sm:w-auto">Agregar</button>
        </div>

        <!-- Equipos -->
        <div class="mb-4 flex flex-col sm:flex-row gap-2 sm:items-end">
            <div class="flex-1">
                <label for="equipo" class="block text-gray-700 font-medium mb-2">Equipo:</label>
                <select id="equipo" class="w-full border rounded p-2 text-sm sm:text-base">
                    <option value="">-- Seleccione Equipo --</option>
                </select>
            </div>
            <button type="button" id="btn-agregar-equipo"
                class="bg-blue-500 text-white px-4 py-2 rounded w-full sm:w-auto">Agregar</button>
        </div>

        <!-- Días de ingreso -->
        <div class="mb-4 flex flex-col sm:flex-row gap-2 sm:items-end">
            <div class="flex-1">
                <label for="dias-ingreso" class="block text-gray-700 font-medium mb-2">Días de Ingreso:</label>
                <input type="number" id="dias-ingreso" class="border rounded p-2 w-full text-sm sm:text-base" min="1">
            </div>
            <div class="flex-1">
                <label for="valor-ingreso" class="block text-gray-700 font-medium mb-2">Valor:</label>
                <input type="number" id="valor-ingreso" class="border rounded p-2 w-full text-sm sm:text-base" min="0"
                    step="0.01">
            </div>
            <button type="button" id="agregar-dias"
                class="bg-blue-500 text-white px-4 py-2 rounded w-full sm:w-auto">Agregar</button>
        </div>

        <!-- Tabla -->
        <div class="overflow-x-auto">
            <label class="block text-gray-700 font-medium mb-2">Items Seleccionados:</label>
            <table id="tabla-items" class="table-auto w-full border text-sm sm:text-base">
                <thead>
                    <tr class="bg-gray-200">
                        <th class="border px-2 py-1">Tipo</th>
                        <th class="border px-2 py-1">Nombre</th>
                        <th class="border px-2 py-1">Precio</th>
                    </tr>
                </thead>
                <tbody></tbody>
            </table>
        </div>

        <div class="text-right font-bold mt-2 text-sm sm:text-base">
            Total: $<span id="total">0.00</span>
        </div>

        <button id="btn-descargar"
            class="bg-green-500 text-white px-4 py-2 rounded mt-4 w-full sm:w-auto block mx-auto sm:mx-0">
            Descargar Tabla
        </button>
    </div>

</body>
<script>
    document.getElementById('btn-descargar').addEventListener('click', () => {
        const tabla = document.getElementById('tabla-items');

        html2canvas(tabla).then(canvas => {
            // Convertimos el canvas a imagen
            const imgData = canvas.toDataURL('image/png');

            // Creamos un enlace para descargar
            const link = document.createElement('a');
            link.href = imgData;
            link.download = 'tabla.png';
            link.click();
        }).catch(error => console.error('Error al generar la imagen:', error));
    });

</script>

</html>